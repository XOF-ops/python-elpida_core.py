name: Deploy to HF Space

on:
  push:
    branches: [main]
    paths:
      - "hf_deployment/**"
  workflow_dispatch:   # allow manual trigger from Actions tab

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # full history needed for subtree

      - name: Configure git
        run: |
          git config user.email "elpida-deploy@github-actions"
          git config user.name "Elpida Deploy Bot"

      - name: Push hf_deployment/ to HF Space
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          set -e

          # Clone the HF Space (shallow, so we can layer on top)
          git clone --depth=1 \
            https://z65nik:${HF_TOKEN}@huggingface.co/spaces/z65nik/elpida-governance-layer \
            /tmp/hf_space

          # Sync hf_deployment/ into the cloned Space (delete files no longer present)
          rsync -av --delete \
            --exclude='.git' \
            --exclude='cache/' \
            ${{ github.workspace }}/hf_deployment/ \
            /tmp/hf_space/

          cd /tmp/hf_space

          # Stage everything
          git add -A

          # Only commit+push if there are actual changes
          if git diff --cached --quiet; then
            echo "No changes to deploy."
          else
            git commit -m "deploy: $(git -C ${{ github.workspace }} log -1 --format='%h %s')"
            git push origin main
          fi
