name: Deploy to HF Space

on:
  push:
    branches: [main]
    paths:
      - "hf_deployment/**"
  workflow_dispatch:   # allow manual trigger from Actions tab

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # full history needed for subtree

      - name: Configure git
        run: |
          git config --global user.email "elpida-deploy@github-actions"
          git config --global user.name "Elpida Deploy Bot"

      - name: Push hf_deployment/ to HF Space
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          set -e
          HF_URL="https://z65nik:${HF_TOKEN}@huggingface.co/spaces/z65nik/elpida-governance-layer"

          # Full clone (no --depth) so we can push normally without history conflicts
          git clone "$HF_URL" /tmp/hf_space

          # Remove all tracked files (so rsync --delete is the single source of truth)
          git -C /tmp/hf_space rm -rf . 2>/dev/null || true

          # Sync hf_deployment/ content into the Space root
          rsync -av \
            --exclude='.git' \
            --exclude='cache/' \
            ${{ github.workspace }}/hf_deployment/ \
            /tmp/hf_space/

          # Stage everything
          git -C /tmp/hf_space add -A

          if git -C /tmp/hf_space diff --cached --quiet; then
            echo "No changes to deploy."
          else
            git -C /tmp/hf_space commit \
              -m "deploy: $(git -C ${{ github.workspace }} log -1 --format='%h %s')"
            git -C /tmp/hf_space push origin main
            echo "âœ“ HF Space updated"
          fi
