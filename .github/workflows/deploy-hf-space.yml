name: Deploy to HF Space

on:
  push:
    branches: [main]
    paths:
      - "hf_deployment/**"
  workflow_dispatch:   # allow manual trigger from Actions tab

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # full history needed for subtree

      - name: Configure git
        run: |
          git config --global user.email "elpida-deploy@github-actions"
          git config --global user.name "Elpida Deploy Bot"

      - name: Push hf_deployment/ to HF Space
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          set -e
          HF_URL="https://z65nik:${HF_TOKEN}@huggingface.co/spaces/z65nik/elpida-governance-layer"

          # Shallow clone just to get the remote configured
          git clone --depth=1 "$HF_URL" /tmp/hf_space

          # Switch to an orphan branch (no history — avoids shallow push rejection)
          git -C /tmp/hf_space checkout --orphan deploy_fresh

          # Clear the staging area (orphan starts with same working tree)
          git -C /tmp/hf_space rm -rf . 2>/dev/null || true

          # Sync hf_deployment/ content into the Space root
          rsync -av --delete \
            --exclude='.git' \
            --exclude='cache/' \
            ${{ github.workspace }}/hf_deployment/ \
            /tmp/hf_space/

          # Stage and commit
          git -C /tmp/hf_space add -A

          if git -C /tmp/hf_space diff --cached --quiet; then
            echo "No changes to deploy."
          else
            git -C /tmp/hf_space commit \
              -m "deploy: $(git -C ${{ github.workspace }} log -1 --format='%h %s')"
            # Force push the orphan over HF main (clean rewrite, no shallow ancestry issues)
            git -C /tmp/hf_space push origin deploy_fresh:main --force
            echo "✓ HF Space updated"
          fi
